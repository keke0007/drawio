# 第三节：表单请求和模板

讲师：肖斌

# 一、Jinjia2模板引擎

FastAPI这个Python Web框架并没有带渲染的网页模板引擎，但是也正因为如此，它可以使用任何网页模板。
官方推荐是jinjia2 。

```
pip install jinjia2
```

```python
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

app = FastAPI()

app.mount("/static", StaticFiles(directory="static"), name="static")


templates = Jinja2Templates(directory="templates")


@app.get("/test6/{id}", response_class=HTMLResponse)
def read_item(request: Request, id: str):
    return templates.TemplateResponse("test6.html", {"request": request, "id": id})
```

**注意：**

1. 您也可以使用 `from starlette.templating import Jinja2Templates。`FastAPI 提供相同的功能，只是为了方便您（开发人员）。
2. 返回的模板中：第一个参数是html文件的路径，第二个参数是传给html模板的数据：其中必须携带request

## 本质

fastapi默认的响应数据类型是：`JSONResponse` 。你可以通过response_class来指定返回响应数据的类型。

```python
from fastapi import FastAPI
from fastapi.responses import HTMLResponse

app = FastAPI()


@app.get("/test7/{id}", response_class=HTMLResponse)
def read_items(id: str):
    return f"""
    <html>
        <head>
            <title>test7</title>
        </head>
        <body>
            <h1>{id}</h1>
        </body>
    </html>
    """

```

## 1、模板传参

```python

@app.get("/test", response_class=HTMLResponse)
def test11(request: Request):
    student = {'name': 'Old', 'age': 38, 'gender': '中'}

    student_list = [
        {'name': 'Old', 'age': 38, 'gender': '中'},
        {'name': 'Boy', 'age': 73, 'gender': '男'},
        {'name': 'EDU', 'age': 84, 'gender': '女'}
    ]

    student_dict = {
        'a': {'name': 'Old', 'age': 38, 'gender': '中'},
        'b': {'name': 'Boy', 'age': 73, 'gender': '男'},
        'c': {'name': 'EDU', 'age': 84, 'gender': '女'},
    }
    return templates.TemplateResponse("t1.html", {"request": request, **student})
    return templates.TemplateResponse("t2.html", {"request": request, 'stu_list': student_list})
    return templates.TemplateResponse("t3.html", {"request": request, 'stu_dict': student_dict})
```

## 2、模板语法

在jinja2中，存在三种语法：

1. 控制结构 （逻辑代码）{%    %}
2. 变量取值 {{   }}
3. 注释 {#     #}

## 3、模板语言中的表达式

* 最常用的是变量，由Flask渲染模板时传过来，比如name
* 也可以是任意一种Python基础类型，比如字符串{{stu_list}}；或者数值，列表，元祖，字典，布尔值。
* 运算。包括算数运算，如{{ 2 + 3 }}；比较运算，如{{ 2 > 1 }}；逻辑运算，如{{ False and True }}
* 过滤器|和测试器is
* 函数调用，如{{ current_time() }}；
* 数组下标操作，如{{ arr[1] }}
* in操作符，如{{ 1 in [1,2,3] }}
* 字符串连接符~，作用同Python中的 “+” 一样，如{{ "Hello " ~ name ~ "!" }}
* None值处理{{name or ""}

## 4、控制语句

Jinja2的控制语句主要就是条件控制语句if，和循环控制语句for，语法类似于Python中的if-else，和for语句

```python
条件判断语句：
{% if name and name == 'admin'  %}
    <h1>This is admin console</h1>
{% elif name %}
    <h1>Welcome {{ name }}!</h1>
{% else %}
    <h1>Please login</h1>
{% endif %}

for循环语句：
  {% for stu in stu_list%}
    {{ stu }}
  {% endfor %}

### 
```

## 5、过滤器函数

什么是过滤器?
实质上就是一个转换函数。变量可以通过“过滤器”进行修改，过滤器可以理解为是jinja2里面的内置函数和字符串处理函数。


**常用的过滤器有：**

| **过滤器名称**  | **说明**                                         |
| --------------------- | ------------------------------------------------------ |
| **safe**        | **渲染时值不转义**                               |
| **capitialize** | **把值的首字母转换成大写，其他子母转换为小写**   |
| **lower**       | **把值转换成小写形式**                           |
| **upper**       | **把值转换成大写形式**                           |
| **title**       | **把值中每个单词的首字母都转换成大写**           |
| **trim**        | **把值的首尾空格去掉**                           |
| **striptags**   | **渲染之前把值中所有的HTML标签都删掉**           |
| **join**        | **拼接多个值为字符串**                           |
| **replace**     | **替换字符串的值**                               |
| **round**       | **默认对数字进行四舍五入，也可以用参数进行控制** |
| **int**         | **把值转换成整型**                               |


##### 1、字符串的过滤器

```html
<body>
{# 当变量未定义时，显示默认字符串，可以缩写为d #}
<p>{{ name | default('No name') }}</p>

{# 单词首字母大写 #}
<p>{{ 'hello world' | capitalize }}</p>

{# 单词全小写 #}
<p>{{ 'XML' | lower }}</p>

{# 去除字符串前后的空白字符 #}
<p>{{ '  hello  ' | trim }}</p>

{# 字符串反转，返回"olleh" #}
<p>{{ 'hello' | reverse }}</p>

{# 格式化输出，返回"Number is 99" #}
<p>{{ '%s is %d' | format("Number", 99) }}</p>

{# 关闭HTML自动转义 #}
<p>{{ '<em>name</em>' | safe }}</p>

{% autoescape false %}
{# HTML转义，即使autoescape关了也转义，可以缩写为e #}
<p>{{ '<em>name</em>' | escape }}</p>
{% endautoescape %}

</body>
```

##### 2、数值的过滤器

```html
{# 四舍五入取整，返回13.0 #}
<p>{{ 12.98 | round }}</p>

{# 向下截取到小数点后2位，返回12.88 #}
<p>{{ 12.8888 | round(2, 'floor') }}</p>

{# 绝对值，返回12 #}
<p>{{ -12 | abs }}</p>
```

##### 3、列表相关的过滤器

```html
# 取第一个元素 #}
<p>{{ [1,2,3] | first }}</p>

{# 取最后一个元素 #}
<p>{{ [1,2,3] | last }}</p>

{# 返回列表长度，可以写为count #}
<p>{{ [1,2,3,4,5] | length }}</p>

{# 列表求和 #}
<p>{{ [1,2,3,4,5] | sum }}</p>

{# 列表排序，默认为升序 #}
<p>{{ [3,2,1,5,4] | sort }}</p>

{# 合并为字符串，返回"1 | 2 | 3 | 4 | 5" #}
<p>{{ [1,2,3,4,5] | join(' | ') }}</p>

{# 列表中所有元素都全大写。这里可以用upper,lower，但capitalize无效 #}
<p>{{ ['alex','bob','ada'] | upper }}</p>
```

##### 4、字典相关的过滤器

```html
{% set users=[{'name':'Tom','gender':'M','age':20},
              {'name':'John','gender':'M','age':18},
              {'name':'Mary','gender':'F','age':24},
              {'name':'Bob','gender':'M','age':31},
              {'name':'Lisa','gender':'F','age':19}]
%}


{# 按指定字段排序，这里设reverse为true使其按降序排 #}
<ul>
{% for user in users | sort(attribute='age', reverse=true) %}
     <li>{{ user.name }}, {{ user.age }}</li>
{% endfor %}
</ul>

{# 列表分组，每组是一个子列表，组名就是分组项的值 #}
<ul>
{% for group in users|groupby('gender') %}
    <li>{{ group.grouper }}<ul>
    {% for user in group.list %}
        <li>{{ user.name }}</li>
    {% endfor %}</ul></li>
{% endfor %}
</ul>

{# 取字典中的某一项组成列表，再将其连接起来 #}
<p>{{ users | map(attribute='name') | join(', ') }}</p>
```

## 6、测试器函数

测试器总是返回一个布尔值，它可以用来测试一个变量或者表达式，使用”is”关键字来进行测试。

测试器本质上也是一个函数，它的第一个参数就是待测试的变量，在模板中使用时可以省略去。如果它有第二个参数，模板中就必须传进去。测试器函数返回的必须是一个布尔值，这样才可以用来给if语句作判断。

```python
{# 检查变量是否被定义，也可以用undefined检查是否未被定义 #}
{% if name is defined %}
    <p>Name is: {{ name }}</p>
{% endif %}

{# 检查是否所有字符都是大写 #}
{% if name is upper %}
  <h2>"{{ name }}" are all upper case.</h2>
{% endif %}

{# 检查变量是否为空 #}
{% if name is none %}
  <h2>Variable is none.</h2>
{% endif %}

{# 检查变量是否为字符串，也可以用number检查是否为数值 #}
{% if name is string %}
  <h2>{{ name }} is a string.</h2>
{% endif %}

{# 检查数值是否是偶数，也可以用odd检查是否为奇数 #}
{% if 2 is even %}
  <h2>Variable is an even number.</h2>
{% endif %}

{# 检查变量是否可被迭代循环，也可以用sequence检查是否是序列 #}
{% if [1,2,3] is iterable %}
  <h2>Variable is iterable.</h2>
{% endif %}

{# 检查变量是否是字典 #}
{% if {'name':'test'} is mapping %}
  <h2>Variable is dict.</h2>
{% endif %}
```

## 7、字模板和继承


一般我们的网站虽然页面多，但是很多部分是重用的，比如页首，页脚，导航栏之类的。对于每个页面，都要写这些代码，很麻烦。

Flask的Jinja2模板支持模板继承功能，省去了这些重复代码。

**父模板：**

```
<body>
你好，template1
{% block template1 %}

{% endblock %}
你好，template2
{% block template2 %}

{% endblock %}
你好，template
{% block template %}

{% endblock %}
</body>
```

**子模版：**

```
{% extends "he.html" %}

{% block template %}
{{ super() }}
    <h1>yuan</h1>
{% endblock %}

{% block template1 %}
{{ super() }}
    <h1>alex</h1>
{% endblock %}


```

# 二、form表单请求

1、添加员工信息

```
@app.get("/test8", response_class=HTMLResponse)
def test8(request: Request):
    return templates.TemplateResponse("test7.html", {"request": request})


@app.post("/test9")
def test9(name: str = Form(), sex: str = Form(), phone: str = Form(), email: str = Form()):
    print(name)
    print(sex)
    print(phone)
    print(email)
    return '成功'

```

2、上传员工图片

```python
@app.post("/test9")
def test9(name: str = Form(), sex: str = Form(), phone: str = Form(), email: str = Form(), image: Union[UploadFile, None] = None):
    print(name)
    print(sex)
    print(phone)
    print(email)
    if image:
        print(image.filename)
        with open('new.jpg', 'wb') as f:
            f.write(image.file.read())
    return '成功'

```
